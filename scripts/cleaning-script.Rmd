---
title: "Cleaning Script"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Package Loading

```{r}
library(tidyverse)
library(ggpubr)
library(ggsignif)
library(maps)
```

# Data Loading

```{r}
stakeholder_survey <- read.csv("/Users/kenjinchang/github/scr-and-stakeholder-analysis/data/parent-files/survey-data.csv")
review_data <- read.csv("/Users/kenjinchang/github/scr-and-stakeholder-analysis/data/parent-files/review-data.csv")
```

# Cleaning

First, we will need to select and rename the variables relevant to our plan of analysis. We will specifically focus on the following: 

* `date`, which corresponds to the date and time the response was recorded
* `completion`, which corresponds to the proportion of the survey that was completed
* `channel`, which corresponds to the means through which the survey materials were accessed
* `consent`, which corresponds to whether participants provided informed consent 
* `involvement`, which corresponds to the participants' self-reported role in deciding dining policies and practices
* `involvement_other`, which corresponds to to offered clarifications on participants' reported roles in deciding dining policies and practices
* `stakeholder_type`, which corresponds to the type of professional role participants reported as serving
* `stakeholder_type_other`, which corresponds to offered clarifications on the type of professional role participants reported as serving
* `title`, which corresponds to participants' disclosed job titles
* `role_duration`, which corresponds to the number of years participants have served in that position
* `dietary_health_ranking`, which corresponds to the level of priority given to the healthiness of food offerings
* `dietary_sustainability_ranking`, which corresponds to the level of priority given to the sustainability of guest food choices
* `institutional_sustainability_ranking`, which corresponds to the level of priority given to the sustainability of dining operations
* `food_pricing_ranking`, which corresponds to the level of priority given to the campus food prices
* `operational_costs_ranking`, which corresponds to the level of priority given to cost of funding dining operations
* `guest_satisfaction_ranking`, which corresponds to the level of priority given to the dining experiences of students
* `worker_satisfaction_ranking`, which corresponds to the level of priority given to the labor experiences of dining staff
* `campus_culture_ranking`, which corresponds to the level of priority given to campus sustainability culture and the monitoring of spillover effects
* `other_ranking`, which corresponds to the level of priority given to other relevant indicators of university-based dietary intervention performance not considered in the provided list
* `other_ranking_other`, which corresponds to offered indicators

```{r}
stakeholder_survey <- stakeholder_survey %>%
  select(RecordedDate,Progress,DistributionChannel,Q1,Q2,Q2_4_TEXT,Q6,Q6_10_TEXT,Q3,Q5_1,Q2_1,Q2_2,Q2_3,Q2_4,Q2_5,Q2_6,Q2_7,Q2_8,Q2_9,Q2_9_TEXT) %>%
  rename(date=RecordedDate,completion=Progress,channel=DistributionChannel,consent=Q1,involvement=Q2,involvement_other=Q2_4_TEXT,stakeholder_type=Q6,stakeholder_type_other=Q6_10_TEXT,title=Q3,role_duration=Q5_1,dietary_health_ranking=Q2_1,dietary_sustainability_ranking=Q2_2,institutional_sustainability_ranking=Q2_3,food_pricing_ranking=Q2_4,operational_costs_ranking=Q2_5,guest_satisfaction_ranking=Q2_6,worker_satisfaction_ranking=Q2_7,campus_culture_ranking=Q2_8,other_ranking=Q2_9,other_ranking_other=Q2_9_TEXT) 
```

We also need to (1) omit the first three rows, which contain information about how the survey variables are coded and (2) reclass the `dietary_health_ranking`, `dietary_sustainability_ranking`, `institutional_sustainability_ranking`, `food_price_ranking`, `operational_costs_ranking`, `guest_satisfaction_ranking`, `worker_satisfaction_ranking`, `campus_culure_ranking`, and `other_ranking` variables from characteric strings to numeric vectors. 

```{r}
stakeholder_survey <- stakeholder_survey %>%
  slice(3:n()) %>%
  mutate(dietary_health_ranking=as.numeric(dietary_health_ranking)) %>%
  mutate(dietary_sustainability_ranking=as.numeric(dietary_sustainability_ranking)) %>%
  mutate(institutional_sustainability_ranking=as.numeric(institutional_sustainability_ranking)) %>%
  mutate(food_pricing_ranking=as.numeric(food_pricing_ranking)) %>%
  mutate(operational_costs_ranking=as.numeric(operational_costs_ranking)) %>%
  mutate(guest_satisfaction_ranking=as.numeric(guest_satisfaction_ranking)) %>%
  mutate(worker_satisfaction_ranking=as.numeric(worker_satisfaction_ranking)) %>%
  mutate(campus_culture_ranking=as.numeric(campus_culture_ranking)) %>%
  mutate(other_ranking=as.numeric(other_ranking)) 
```

With this complete, we can now move on to address an isolated difference in how one subject elected to respond to the rank-order choice set. More specifically, this participant used the provided prompt to suggest an unlisted performance indicator in `other_ranking_other`, with all other respondents ranking `other_ranking` last and without any additional details. Given this, in the interest of constructing a consistent scoring system, we will narratively note the omission of the suggested "Cuisine type" indicator in our results while simultaneously removing the `other_ranking` and `other_ranking_other` variables from the variable list. 

In this particular instance, because the subject identified this previously unspecified indicator with a rank of "2," this requires us to subtract 1 from every ranked indicator apart from `guest_satisfaction_ranking`, which was ranked first, ahead of "Cuisine type."

To accomplish this, we will first transform the data by adding variable `id` to attach unique identifiers to each individual response. This will help us isolate the changes in ranking to the one outlying response set.

```{r}
stakeholder_survey <- stakeholder_survey %>%
  mutate(id=row_number())
```


Now, we move on to the next step, which involves recoding all rank responses greater than "2," such that every performance indicator apart from `guest_satisfaction_ranking` moves one position ahead to compensate for the joint removal of `other_ranking` and `other_ranking_other`.

```{r}
stakeholder_survey <- stakeholder_survey %>%
  mutate(campus_culture_ranking=case_when(id == 22 ~ 8,
                                          TRUE ~ campus_culture_ranking)) %>%
  mutate(worker_satisfaction_ranking=case_when(id == 22 ~ 7,
                                          TRUE ~ worker_satisfaction_ranking)) %>%
  mutate(operational_costs_ranking=case_when(id == 22 ~ 2,
                                          TRUE ~ worker_satisfaction_ranking)) %>%
  mutate(food_pricing_ranking=case_when(id == 22 ~ 3,
                                          TRUE ~ food_pricing_ranking)) %>%
  mutate(institutional_sustainability_ranking=case_when(id == 22 ~ 4,
                                          TRUE ~ institutional_sustainability_ranking)) %>%
  mutate(dietary_sustainability_ranking=case_when(id == 22 ~ 5,
                                          TRUE ~ dietary_sustainability_ranking)) %>%
  mutate(dietary_health_ranking=case_when(id == 22 ~ 6,
                                          TRUE ~ dietary_health_ranking)) 
```

With 

```{r}
stakeholder_survey <- stakeholder_survey %>% 
  select(-other_ranking,-other_ranking_other)
```

Inverted scoring system

```{r}
stakeholder_survey <- stakeholder_survey %>%
  mutate(dietary_health_score=case_when(dietary_health_ranking == 1 ~ 8,
                                        dietary_health_ranking == 2 ~ 7,
                                        dietary_health_ranking == 3 ~ 6,
                                        dietary_health_ranking == 4 ~ 5,
                                        dietary_health_ranking == 5 ~ 4,
                                        dietary_health_ranking == 6 ~ 3,
                                        dietary_health_ranking == 7 ~ 2,
                                        dietary_health_ranking == 8 ~ 1)) %>%
  mutate(dietary_sustainability_score=case_when(dietary_sustainability_ranking == 1 ~ 8,
                                        dietary_sustainability_ranking == 2 ~ 7,
                                        dietary_sustainability_ranking == 3 ~ 6,
                                        dietary_sustainability_ranking == 4 ~ 5,
                                        dietary_sustainability_ranking == 5 ~ 4,
                                        dietary_sustainability_ranking == 6 ~ 3,
                                        dietary_sustainability_ranking == 7 ~ 2,
                                        dietary_sustainability_ranking == 8 ~ 1)) %>%
  mutate(institutional_sustainability_score=case_when(institutional_sustainability_ranking == 1 ~ 9,
                                        institutional_sustainability_ranking == 2 ~ 8,
                                        institutional_sustainability_ranking == 3 ~ 7,
                                        institutional_sustainability_ranking == 4 ~ 6,
                                        institutional_sustainability_ranking == 5 ~ 5,
                                        institutional_sustainability_ranking == 6 ~ 4,
                                        institutional_sustainability_ranking == 7 ~ 3,
                                        institutional_sustainability_ranking == 8 ~ 2,
                                        institutional_sustainability_ranking == 9 ~ 1)) %>%
  mutate(food_pricing_score=case_when(food_pricing_ranking == 1 ~ 8,
                                        food_pricing_ranking == 2 ~ 7,
                                        food_pricing_ranking == 3 ~ 6,
                                        food_pricing_ranking == 4 ~ 5,
                                        food_pricing_ranking == 5 ~ 4,
                                        food_pricing_ranking == 6 ~ 3,
                                        food_pricing_ranking == 7 ~ 2,
                                        food_pricing_ranking == 8 ~ 1)) %>%
  mutate(operational_costs_score=case_when(operational_costs_ranking == 1 ~ 8,
                                        operational_costs_ranking == 2 ~ 7,
                                        operational_costs_ranking == 3 ~ 6,
                                        operational_costs_ranking == 4 ~ 5,
                                        operational_costs_ranking == 5 ~ 4,
                                        operational_costs_ranking == 6 ~ 3,
                                        operational_costs_ranking == 7 ~ 2,
                                        operational_costs_ranking == 8 ~ 1)) %>%
  mutate(guest_satisfaction_score=case_when(guest_satisfaction_ranking == 1 ~ 8,
                                        guest_satisfaction_ranking == 2 ~ 7,
                                        guest_satisfaction_ranking == 3 ~ 6,
                                        guest_satisfaction_ranking == 4 ~ 5,
                                        guest_satisfaction_ranking == 5 ~ 4,
                                        guest_satisfaction_ranking == 6 ~ 3,
                                        guest_satisfaction_ranking == 7 ~ 2,
                                        guest_satisfaction_ranking == 8 ~ 1)) %>%
  mutate(worker_satisfaction_score=case_when(worker_satisfaction_ranking == 1 ~ 8,
                                        worker_satisfaction_ranking == 2 ~ 7,
                                        worker_satisfaction_ranking == 3 ~ 6,
                                        worker_satisfaction_ranking == 4 ~ 5,
                                        worker_satisfaction_ranking == 5 ~ 4,
                                        worker_satisfaction_ranking == 6 ~ 3,
                                        worker_satisfaction_ranking == 7 ~ 2,
                                        worker_satisfaction_ranking == 8 ~ 1)) %>%
  mutate(campus_culture_score=case_when(campus_culture_ranking == 1 ~ 8,
                                        campus_culture_ranking == 2 ~ 7,
                                        campus_culture_ranking == 3 ~ 6,
                                        campus_culture_ranking == 4 ~ 5,
                                        campus_culture_ranking == 5 ~ 4,
                                        campus_culture_ranking == 6 ~ 3,
                                        campus_culture_ranking == 7 ~ 2,
                                        campus_culture_ranking == 8 ~ 1)) 
```


```{r}
stakeholder_survey %>% mutate(dietary_sustainability_over_dietary_health=case_when(dietary_sustainability_ranking<dietary_health_ranking ~ 1,
                                                                                   dietary_sustainability_ranking>dietary_health_ranking ~ 0)) %>%
  summarise(dietary_sustainability_over_dietary_health_sum=sum(dietary_sustainability_over_dietary_health))
```
```{r}
stakeholder_survey %>% mutate(institutional_sustainability_over_dietary_health=case_when(institutional_sustainability_ranking<dietary_health_ranking ~ 1,
                                                                                   institutional_sustainability_ranking>dietary_health_ranking ~ 0)) %>%
  summarise(institutional_sustainability_over_dietary_health_sum=sum(institutional_sustainability_over_dietary_health))
```

```{r}
stakeholder_survey %>% mutate(food_pricing_over_dietary_health=case_when(food_pricing_ranking<dietary_health_ranking ~ 1,
                                                                                   food_pricing_ranking>dietary_health_ranking ~ 0)) %>%
  summarise(food_pricing_over_dietary_health_sum=sum(food_pricing_over_dietary_health))
```

```{r}
stakeholder_survey %>% mutate(operational_costs_over_dietary_health=case_when(operational_costs_ranking<dietary_health_ranking ~ 1,
                                                                                   operational_costs_ranking>dietary_health_ranking ~ 0)) %>%
  summarise(operational_costs_over_dietary_health_sum=sum(operational_costs_over_dietary_health))
```

```{r}
stakeholder_survey %>% mutate(guest_satisfaction_over_dietary_health=case_when(guest_satisfaction_ranking<dietary_health_ranking ~ 1,
                                                                                   guest_satisfaction_ranking>dietary_health_ranking ~ 0)) %>%
  summarise(guest_satisfaction_over_dietary_health_sum=sum(guest_satisfaction_over_dietary_health))
```
```{r}
stakeholder_survey %>% mutate(worker_satisfaction_over_dietary_health=case_when(worker_satisfaction_ranking<dietary_health_ranking ~ 1,
                                                                                   worker_satisfaction_ranking>dietary_health_ranking ~ 0)) %>%
  summarise(worker_satisfaction_over_dietary_health_sum=sum(worker_satisfaction_over_dietary_health))
```
```{r}
stakeholder_survey %>% mutate(campus_culture_over_dietary_health=case_when(campus_culture_ranking<dietary_health_ranking ~ 1,
                                                                                   campus_culture_ranking>dietary_health_ranking ~ 0)) %>%
  summarise(campus_culture_over_dietary_health_sum=sum(campus_culture_over_dietary_health))
```

```{r}
stakeholder_survey %>% mutate(institutional_sustainability_over_dietary_sustainability=case_when(institutional_sustainability_ranking<dietary_sustainability_ranking ~ 1,
                                                                                   institutional_sustainability_ranking>dietary_sustainability_ranking ~ 0)) %>%
  summarise(institutional_sustainability_over_dietary_sustainability_sum=sum(institutional_sustainability_over_dietary_sustainability))
```
```{r}
stakeholder_survey %>% mutate(food_pricing_over_dietary_sustainability=case_when(food_pricing_ranking<dietary_sustainability_ranking ~ 1,
                                                                                   food_pricing_ranking>dietary_sustainability_ranking ~ 0)) %>%
  summarise(food_pricing_over_dietary_sustainability_sum=sum(food_pricing_over_dietary_sustainability))
```

```{r}
stakeholder_survey %>% mutate(operational_costs_over_dietary_sustainability=case_when(operational_costs_ranking<dietary_sustainability_ranking ~ 1,
                                                                                   operational_costs_ranking>dietary_sustainability_ranking ~ 0)) %>%
  summarise(operational_costs_over_dietary_sustainability_sum=sum(operational_costs_over_dietary_sustainability))
```

```{r}
stakeholder_survey %>% mutate(guest_satisfaction_over_dietary_sustainability=case_when(guest_satisfaction_ranking<dietary_sustainability_ranking ~ 1,
                                                                                   guest_satisfaction_ranking>dietary_sustainability_ranking ~ 0)) %>%
  summarise(guest_satisfaction_over_dietary_sustainability_sum=sum(guest_satisfaction_over_dietary_sustainability))
```

```{r}
stakeholder_survey %>% mutate(campus_culture_over_dietary_sustainability=case_when(campus_culture_ranking<dietary_sustainability_ranking ~ 1,
                                                                                   campus_culture_ranking>dietary_sustainability_ranking ~ 0)) %>%
  summarise(campus_culture_over_dietary_sustainability_sum=sum(campus_culture_over_dietary_sustainability))
```
```{r}
stakeholder_survey %>% mutate(food_pricing_over_institutional_sustainability=case_when(food_pricing_ranking<institutional_sustainability_ranking ~ 1,
                                                                                   food_pricing_ranking>institutional_sustainability_ranking ~ 0)) %>%
  summarise(food_pricing_over_institutional_sustainability_sum=sum(food_pricing_over_institutional_sustainability))
```

```{r}
stakeholder_survey %>% mutate(operational_costs_over_institutional_sustainability=case_when(operational_costs_ranking<institutional_sustainability_ranking ~ 1,
                                                                                   operational_costs_ranking>institutional_sustainability_ranking ~ 0)) %>%
  summarise(operational_costs_over_institutional_sustainability_sum=sum(operational_costs_over_institutional_sustainability))
```

```{r}
stakeholder_survey %>% mutate(guest_satisfaction_over_institutional_sustainability=case_when(guest_satisfaction_ranking<institutional_sustainability_ranking ~ 1,
                                                                                   guest_satisfaction_ranking>institutional_sustainability_ranking ~ 0)) %>%
  summarise(guest_satisfaction_over_institutional_sustainability_sum=sum(guest_satisfaction_over_institutional_sustainability))
```
```{r}
stakeholder_survey %>% mutate(worker_satisfaction_over_institutional_sustainability=case_when(worker_satisfaction_ranking<institutional_sustainability_ranking ~ 1,
                                                                                   worker_satisfaction_ranking>institutional_sustainability_ranking ~ 0)) %>%
  summarise(worker_satisfaction_over_institutional_sustainability_sum=sum(worker_satisfaction_over_institutional_sustainability))
```


```{r}
stakeholder_survey %>% mutate(campus_culture_over_institutional_sustainability=case_when(campus_culture_ranking<institutional_sustainability_ranking ~ 1,
                                                                                   campus_culture_ranking>institutional_sustainability_ranking ~ 0)) %>%
  summarise(campus_culture_over_institutional_sustainability_sum=sum(campus_culture_over_institutional_sustainability))
```

```{r}
stakeholder_survey %>% mutate(operational_costs_over_food_pricing=case_when(operational_costs_ranking<food_pricing_ranking ~ 1,
                                                                                   operational_costs_ranking>food_pricing_ranking ~ 0)) %>%
  summarise(operational_costs_over_food_pricing_sum=sum(operational_costs_over_food_pricing))
```

```{r}
stakeholder_survey %>% mutate(guest_satisfaction_over_food_pricing=case_when(guest_satisfaction_ranking<food_pricing_ranking ~ 1,
                                                                                   guest_satisfaction_ranking>food_pricing_ranking ~ 0)) %>%
  summarise(guest_satisfaction_over_food_pricing_sum=sum(guest_satisfaction_over_food_pricing))
```

```{r}
stakeholder_survey %>% mutate(worker_satisfaction_over_food_pricing=case_when(worker_satisfaction_ranking<food_pricing_ranking ~ 1,
                                                                                   worker_satisfaction_ranking>food_pricing_ranking ~ 0)) %>%
  summarise(worker_satisfaction_over_food_pricing_sum=sum(worker_satisfaction_over_food_pricing))
```

```{r}
stakeholder_survey %>% mutate(campus_culture_over_food_pricing=case_when(campus_culture_ranking<food_pricing_ranking ~ 1,
                                                                                   campus_culture_ranking>food_pricing_ranking ~ 0)) %>%
  summarise(campus_culture_over_food_pricing_sum=sum(campus_culture_over_food_pricing))
```

```{r}
stakeholder_survey %>% mutate(guest_satisfaction_over_operational_costs=case_when(guest_satisfaction_ranking<operational_costs_ranking ~ 1,
                                                                                   guest_satisfaction_ranking>operational_costs_ranking ~ 0)) %>%
  summarise(guest_satisfaction_over_operational_costs_sum=sum(guest_satisfaction_over_operational_costs))
```


```{r}
stakeholder_survey %>% 
  mutate(worker_satisfaction_over_operational_costs=case_when(worker_satisfaction_ranking<operational_costs_ranking ~ 1,
                                                                                   worker_satisfaction_ranking>operational_costs_ranking ~ 0)) %>%
  summarise(worker_satisfaction_over_operational_costs_sum=sum(worker_satisfaction_over_operational_costs))
```

%>%
  summarise(worker_satisfaction_over_operational_costs_sum=sum(worker_satisfaction_over_operational_costs))



```{r}
stakeholder_survey %>% mutate(campus_culture_over_operational_costs=case_when(campus_culture_ranking<operational_costs_ranking ~ 1,
                                                                                   campus_culture_ranking>operational_costs_ranking ~ 0)) %>%
  summarise(campus_culture_over_operational_costs_sum=sum(campus_culture_over_operational_costs))
```

```{r}
stakeholder_survey %>% mutate(worker_satisfaction_over_guest_satisfaction=case_when(worker_satisfaction_ranking<guest_satisfaction_ranking ~ 1,
                                                                                   worker_satisfaction_ranking>guest_satisfaction_ranking ~ 0)) %>%
  summarise(worker_satisfaction_over_guest_satisfaction_sum=sum(worker_satisfaction_over_guest_satisfaction))
```


```{r}
stakeholder_survey %>% mutate(campus_culture_over_guest_satisfaction=case_when(campus_culture_ranking<guest_satisfaction_ranking ~ 1,
                                                                                   campus_culture_ranking>guest_satisfaction_ranking ~ 0)) %>%
  summarise(campus_culture_over_guest_satisfaction_sum=sum(campus_culture_over_guest_satisfaction))
```

```{r}
stakeholder_survey %>% mutate(campus_culture_over_worker_satisfaction=case_when(campus_culture_ranking<worker_satisfaction_ranking ~ 1,
                                                                                   campus_culture_ranking>worker_satisfaction_ranking ~ 0)) %>%
  summarise(campus_culture_over_worker_satisfaction_sum=sum(campus_culture_over_worker_satisfaction))
```

will need to bridge some of these steps, specifically by using qnorm to perform z-score conversions 

for now, we will do our one-way anova and post-hoc tukey tests by creating a tibble from the information provided in table 4



```{r}
holdover_survey_data <- read.csv("/Users/kenjinchang/github/scr-and-stakeholder-analysis/data/holdover-survey-data.csv")
```


```{r}
summary_table <- holdover_survey_data %>% 
  group_by(group) %>%
  summarise(count=n(),
            mean=mean(z_score),
            sd=sd(z_score))
summary_table
```

```{r}
summary_table %>%
  summarise(mean=mean(mean))
```


```{r}
holdover_survey_data %>%
  mutate(across(group,str_replace,"Guest Dining Experiences","Dining Experience")) %>%
  mutate(across(group,str_replace,"Healthiness of Food Offerings","Dietary Health")) %>%
  mutate(across(group,str_replace,"Sustainability of Guest Food Choices","Dietary Sustainability")) %>%
  mutate(across(group,str_replace,"Institutional Sustainability","Organizational Sustainability")) %>%
  mutate(across(group,str_replace,"Campus Food Prices","Food Pricing")) %>%
  mutate(across(group,str_replace,"Operational and Procurement Costs","Operating Costs")) %>%
  mutate(across(group,str_replace,"Worker Satisfaction","Staff Satisfaction")) %>%
  mutate(across(group,str_replace,"Campus Culture","Campus Culture")) %>%
  ggplot(aes(y=z_score,x=fct_reorder(group,z_score,.fun="mean"),fill=group,color=group)) + 
  geom_boxplot(outlier.shape=NA,alpha=0.5) +
  geom_jitter(width=0.33,size=2,shape=21,alpha=0.5) +
  geom_hline(yintercept=-0.001115625,linetype="dashed",size=0.3) +
  geom_signif(comparisons=list(c("Dining Experience","Staff Satisfaction")),color="black",size=0.25,annotation="***",y_position=-1.4,tip_length=-0.02,vjust=1) +
  geom_signif(comparisons=list(c("Dining Experience","Campus Culture")),color="black",size=0.25,annotation="***",y_position=-1.3,tip_length=-0.02,vjust=1) +
  geom_signif(comparisons=list(c("Dining Experience","Organizational Sustainability")),color="black",size=0.25,annotation="***",y_position=-1.2,tip_length=-0.02,vjust=1) +
  geom_signif(comparisons=list(c("Dining Experience","Operating Costs")),color="black",size=0.25,annotation="***",y_position=-1.1,tip_length=-0.02,vjust=1) +
  geom_signif(comparisons=list(c("Dining Experience","Food Pricing")),color="black",size=0.25,annotation="**",y_position=-1.0,tip_length=-0.02,vjust=1) +
  geom_signif(comparisons=list(c("Dining Experience","Dietary Sustainability")),color="black",size=0.25,annotation="**",y_position=-0.9,tip_length=-0.02,vjust=1) +
  geom_signif(comparisons=list(c("Staff Satisfaction","Dietary Health")),color="black",size=0.25,annotation="*",y_position=0.6,tip_length=0.02,vjust=0.4) +
  scale_fill_brewer(palette="Paired") + 
  scale_color_brewer(palette="Paired") +
  xlab("") + 
  ylab("Priority Score") +
  stat_summary(fun.y=mean,geom="point",shape=20,size=3,color="black",fill="white") +
  theme(legend.position="none",legend.justification="right",legend.box.spacing=unit(0,"pt"),legend.key.size=unit(10,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10)) + 
  coord_flip()
```
```{r}
holdover_survey_data %>%
  mutate(across(group,str_replace,"Guest Dining Experiences","Dining Experience")) %>%
  mutate(across(group,str_replace,"Healthiness of Food Offerings","Dietary Health")) %>%
  mutate(across(group,str_replace,"Sustainability of Guest Food Choices","Dietary Sustainability")) %>%
  mutate(across(group,str_replace,"Institutional Sustainability","Organizational Sustainability")) %>%
  mutate(across(group,str_replace,"Campus Food Prices","Food Pricing")) %>%
  mutate(across(group,str_replace,"Operational and Procurement Costs","Operating Costs")) %>%
  mutate(across(group,str_replace,"Worker Satisfaction","Staff Satisfaction")) %>%
  mutate(across(group,str_replace,"Campus Culture","Campus Culture")) %>%
  ggplot(aes(y=z_score,x=fct_reorder(group,z_score,.fun="mean"),fill=group,color=group)) + 
  geom_violin(draw_quantiles=0.5,adjust=0.66,alpha=0.5,scale="width",trim=TRUE) + 
  geom_jitter(width=0.33,size=2,shape=21,alpha=0.5) +
  geom_hline(yintercept=-0.001115625,linetype="dashed",size=0.3) +
  geom_signif(comparisons=list(c("Dining Experience","Staff Satisfaction")),color="black",size=0.25,annotation="***",y_position=-1.4,tip_length=-0.02,vjust=1) +
  geom_signif(comparisons=list(c("Dining Experience","Campus Culture")),color="black",size=0.25,annotation="***",y_position=-1.3,tip_length=-0.02,vjust=1) +
  geom_signif(comparisons=list(c("Dining Experience","Organizational Sustainability")),color="black",size=0.25,annotation="***",y_position=-1.2,tip_length=-0.02,vjust=1) +
  geom_signif(comparisons=list(c("Dining Experience","Operating Costs")),color="black",size=0.25,annotation="***",y_position=-1.1,tip_length=-0.02,vjust=1) +
  geom_signif(comparisons=list(c("Dining Experience","Food Pricing")),color="black",size=0.25,annotation="**",y_position=-1.0,tip_length=-0.02,vjust=1) +
  geom_signif(comparisons=list(c("Dining Experience","Dietary Sustainability")),color="black",size=0.25,annotation="**",y_position=-0.9,tip_length=-0.02,vjust=1) +
  geom_signif(comparisons=list(c("Staff Satisfaction","Dietary Health")),color="black",size=0.25,annotation="*",y_position=0.6,tip_length=0.02,vjust=0.4) +
  scale_fill_brewer(palette="Paired") + 
  scale_color_brewer(palette="Paired") +
  xlab("") + 
  ylab("Priority Score") +
  stat_summary(fun.y=mean,geom="point",shape=20,size=3,color="black",fill="white") +
  theme(legend.position="none",legend.justification="right",legend.box.spacing=unit(0,"pt"),legend.key.size=unit(10,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10)) + 
  coord_flip()
```


```{r}
aov <- aov(z_score ~ group,data=holdover_survey_data)
summary(aov)
```
multiple tukey pairwise comparisons

```{r}
TukeyHSD(aov)
```

from this, we can glean that there are statistically significant differences between guest satisfaction and six of the remaining performance indicators: culture (p=0.0001151), food pricing (p=0.0067500), institutional sustainability (p=0.0003308), operational costs (p=0.0003974), dietary sustainability (p=0.0089635), and worker satisfaction (p=0.0000146), as well as between worker satisfaction and dietary health (p=0.0120744).

need to stratify by involvement 

```{r}
write.csv(stakeholder_survey,file="/Users/kenjinchang/github/scr-and-stakeholder-analysis/data/cleaned-files/survey-data.csv")
```


```{r}
stakeholder_survey %>% 
  group_by(involvement) %>%
  summarise(count=n())
```









```{r}
stakeholder_survey %>%
  summarise(dietary_health_score_sum=sum(dietary_health_score),dietary_sustainability_score=sum(dietary_sustainability_score),institutional_sustainability_score_sum=sum(institutional_sustainability_score),food_pricing_score_sum=sum(food_pricing_score),operational_costs_score_sum=sum(operational_costs_score),guest_satisfaction_score_sum=sum(guest_satisfaction_score),worker_satisfaction_score_sum=sum(worker_satisfaction_score),campus_culture_score_sum=sum(worker_satisfaction_score),campus_culture_score_sum=sum(campus_culture_score)) 
```


```{r}
stakeholder_survey %>%
  group_by(involvement) %>%
  summarise(dietary_health_score_mean=mean(dietary_health_score),dietary_sustainability_score_mean=mean(dietary_sustainability_score),institutional_sustainability_score_mean=mean(institutional_sustainability_score),institutional_sustainability_score_mean=mean(institutional_sustainability_score),food_pricing_score_mean=mean(food_pricing_score),operational_costs_score_mean=mean(operational_costs_score),guest_satisfaction_score_mean=mean(guest_satisfaction_score),worker_satisfaction_score_mean=mean(worker_satisfaction_score),campus_culture_score_mean=mean(campus_culture_score),n=n())
```

```{r}
stakeholder_survey %>%
  group_by(stakeholder_type) %>%
  summarise(dietary_health_score_mean=mean(dietary_health_score),dietary_sustainability_score_mean=mean(dietary_sustainability_score),institutional_sustainability_score_mean=mean(institutional_sustainability_score),institutional_sustainability_score_mean=mean(institutional_sustainability_score),food_pricing_score_mean=mean(food_pricing_score),operational_costs_score_mean=mean(operational_costs_score),guest_satisfaction_score_mean=mean(guest_satisfaction_score),worker_satisfaction_score_mean=mean(worker_satisfaction_score),campus_culture_score_mean=mean(campus_culture_score),n=n())
```

```{r}
stakeholder_survey %>%
  summarise(dietary_health_score_mean=mean(dietary_health_score),dietary_sustainability_score_mean=mean(dietary_sustainability_score),institutional_sustainability_score_mean=mean(institutional_sustainability_score),institutional_sustainability_score_mean=mean(institutional_sustainability_score),food_pricing_score_mean=mean(food_pricing_score),operational_costs_score_mean=mean(operational_costs_score),guest_satisfaction_score_mean=mean(guest_satisfaction_score),worker_satisfaction_score_mean=mean(worker_satisfaction_score),campus_culture_score_mean=mean(campus_culture_score),n=n())
```
```{r}
stakeholder_survey %>%
  summarise(dietary_health_score_sum=sum(dietary_health_score),dietary_sustainability_score_sum=sum(dietary_sustainability_score),institutional_sustainability_score_sum=sum(institutional_sustainability_score),institutional_sustainability_score_sum=sum(institutional_sustainability_score),food_pricing_score_sum=sum(food_pricing_score),operational_costs_score_sum=sum(operational_costs_score),guest_satisfaction_score_sum=sum(guest_satisfaction_score),worker_satisfaction_score_sum=sum(worker_satisfaction_score),campus_culture_score_sum=sum(campus_culture_score),n=n())
```

















# Extraction Data




```{r}
global_shapefile <- map_data("world")
```

```{r}
global_shapefile <- global_shapefile %>% 
  rename(country=region) %>%
  mutate(country=case_when(country=="Macedonia"~"North Macedonia",
                           country=="Ivory Coast"~"Cote d'Ivoire",
                           country=="Democratic Republic of the Congo"~"Congo, Dem. Rep.",
                           country=="Republic of Congo"~"Congo, Rep.",
                           country=="UK"~"United Kingdom",
                           country=="USA"~"United States",
                           country=="Laos"~"Lao",
                           country=="Slovakia"~"Slovak Republic",
                           country=="Saint Lucia"~"St. Lucia",
                           country=="Kyrgyzstan"~"Krygyz Republic",
                           country=="Micronesia"~"Micronesia, Fed. Sts.",
                           country=="Swaziland"~"Eswatini",
                           country=="Virgin Islands"~"Virgin Islands (U.S.)",
                        TRUE~country))
island_nations <- c("Antigua","Barbuda","Nevis", 
                 "Saint Kitts","Trinidad",
                 "Tobago","Grenadines","Saint Vincent")
island_nations_match <- global_shapefile %>% 
  filter(country %in% island_nations)
island_nations_match %>% distinct(country)
ant_bar <- c(137,138 )
kit_nev <- c(930,931)
tri_tog <- c(1425,1426)
vin_gre <- c(1575,1576,1577)
island_nation_names <- c("Antigua and Barbuda","St. Kitts and Nevis","Trinidad and Tobago","St. Vincent and the Grenadines")
island_nations_match <- island_nations_match %>% 
  mutate(country=case_when(group %in% ant_bar~"Antigua and Barbuda",
                           group %in% kit_nev~"St. Kitts and Nevis",
                           group %in% tri_tog~"Trinidad and Tobago",
                           group %in% vin_gre~"St. Vincent and the Grenadines")) %>% 
  tibble()
island_nations_match %>%
  distinct(country) 
global_shapefile <- global_shapefile %>%
  filter(!country %in% island_nation_names)
global_shapefile <- global_shapefile %>% 
  bind_rows(island_nations_match) %>%
  arrange(country) %>%
  tibble()
sra_names <- c("Hong Kong","Macao")
hk_mc <- global_shapefile %>% 
  filter(subregion %in% sra_names)
hk_mc <- hk_mc %>%
  mutate(country = case_when(subregion=="Hong Kong"~"Hong Kong, China",
                             subregion=="Macao"~"Macao, China"))
global_shapefile <- global_shapefile %>%
  filter(!subregion %in% sra_names)
global_shapefile <- global_shapefile %>% 
  bind_rows(hk_mc) %>%
  select(-subregion) %>% 
  tibble()
```

```{r}
global_shapefile %>%
  distinct(country)
```

```{r}
annual_frequencies <- review_data %>%
  select(Publication.Year,Participating.Institutions) %>%
  drop_na() %>%
  rename(year=Publication.Year,sites=Participating.Institutions) %>%
  mutate(count=case_when(sites >= 1 ~ 1)) %>%
  group_by(year) %>%
  summarise(frequency=sum(count)) 
```


```{r}
annual_frequencies <- annual_frequencies %>% 
  mutate(cumulative_frequency=cumsum(frequency)) %>%
  add_row(year=2000,frequency=0) %>%
  add_row(year=2002,frequency=0) %>%
  add_row(year=2003,frequency=0) %>%
  add_row(year=2004,frequency=0) %>%
  add_row(year=2007,frequency=0) %>%
  add_row(year=2008,frequency=0) %>%
  add_row(year=2010,frequency=0) %>%
  arrange(year) %>%
  mutate(cumulative_frequency=cumsum(frequency)) 
```

```{r}
annual_frequency_plot <- annual_frequencies %>%
  ggplot(aes(x=year,y=frequency,color=frequency,fill=frequency)) +
  geom_col() +
  scale_fill_gradient(name="Count",low="lavender",high="slateblue4",limits=c(1,116),na.value="lavender",breaks=c(1,29,58,87,116)) +
  scale_color_gradient(name="Count",low="lavender",high="slateblue4",limits=c(1,116),na.value="lavender",breaks=c(1,29,58,87,116)) +
  xlab("Year") + 
  ylab("Frequency") + 
  theme(legend.position="none",legend.justification="center",legend.box.spacing=unit(0,"pt"),legend.key.size=unit(10,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

```{r}
annual_cumulative_frequency_plot <- annual_frequencies %>% 
  ggplot(aes(x=year,y=cumulative_frequency,color=cumulative_frequency,fill=cumulative_frequency)) +
  scale_fill_gradient(name="Count",low="lavender",high="slateblue4",limits=c(1,116),na.value="lavender",breaks=c(1,29,58,87,116)) +
  scale_color_gradient(name="Count",low="lavender",high="slateblue4",limits=c(1,116),na.value="lavender",breaks=c(1,29,58,87,116)) +
  geom_col() + 
  xlab("Year") + 
  ylab("Cumulative Frequency") + 
  labs(caption="Adjusted R-Squared: 0.9857 ") + 
  theme(legend.title.position="top",legend.position="bottom",legend.justification="center",legend.box.spacing=unit(0,"pt"),legend.key.width=unit(50,"pt"),legend.key.height=unit(7.5,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="white"),panel.border=element_rect(fill=NA),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
```

```{r}
ggarrange(annual_frequency_plot,annual_cumulative_frequency_plot,
          nrow=2,
          labels=c("A","B"),
          heights=c(1.15,1.7))
```


```{r}
exponential_fit <- annual_frequencies %>%
  slice(-1)
exponential_model <- lm(log(cumulative_frequency) ~ year,data=exponential_fit)
summary(exponential_model)
```


```{r}
review_data <- review_data %>% 
  select(Country_2,Participating.Institutions) %>%
  rename(country=Country_2,institutions=Participating.Institutions)
```

```{r}
review_data <- review_data %>%
  mutate(across(country,str_replace,"USA","United States")) %>%
  mutate(across(country,str_replace,"UK","United Kingdom")) 
```


```{r}
review_data <- review_data %>%
  group_by(country) %>%
  summarise(count=sum(institutions))
```

```{r}
review_data %>% arrange(desc(count))
```

```{r}
aggregated_data <- left_join(global_shapefile,review_data,by="country")
```

```{r}
global_frequencies <- aggregated_data %>%
  ggplot(aes(x=long,y=lat,fill=count,group=group)) + 
  geom_polygon(color="black",linewidth=0.125,alpha=0.75) +
  scale_fill_gradient(low="lavender",high="slateblue4",na.value="white",name="Intervention-Receiving Institutions",guide=guide_colourbar(reverse=FALSE,alpha=0.75,title.position="top",title.hjust=0.5,limits=c(1,74))) +
  scale_y_continuous(limits=c(-60,90)) + 
  xlab("") + 
  ylab("") +
  labs(caption="") +
  theme(legend.key.width=unit(3,"lines"),legend.position="bottom",legend.justification="center",legend.box.spacing=unit(-15,"pt"),legend.key.size=unit(10,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="aliceblue"),panel.border=element_rect(fill=NA),axis.text=element_blank(),axis.ticks=element_blank(),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
global_frequencies
```


```{r}
uk_shapefile <- map_data("world",region="UK")
```

```{r}
uk_shapefile %>%
  distinct(subregion)
```

```{r}
usa_shapefile <- map_data("state") %>%
  rename(state=region)
```

```{r}
usa_shapefile %>%
  distinct(state)
```


```{r}
usa_data <- read.csv("/Users/kenjinchang/github/scr-and-stakeholder-analysis/data/parent-files/review-data.csv") %>%
  select(State..If.in.USA.) %>%
  rename(region=State..If.in.USA.) 
```


```{r}
usa_data %>%
  mutate(region=as.list(region)) %>%
  mutate(across(region,str_replace_all,";",",")) %>%
  unnest(region,.sep=",") %>%
  count(region, name="count") #still need to remove grouped rows
```
* Alabama 
* Arizona
* Arkansas
* California
* Colorado
* Florida
* Georgia
* Illinois
* Indiana
* Kentucky
* Maine
* Massachusetts
* Michigan
* Nebraska
* New Jersey
* New York
* North Carolina
* Ohio
* Oklahoma
* Pennsylvania
* Rhode Island
* South Dakota
* Tennessee
* Texas
* Utah
* Vermont
* Virginia
* Wisconsin

```{r}
usa_data %>%
  str_count("Alabama") 
state_frequencies <- tibble(state="alabama",
       frequency=1)
```

```{r}
usa_data %>%
  str_count("Arizona") 
state_frequencies <- state_frequencies %>%
  add_row(state="arizona",frequency=1)
```

```{r}
usa_data %>%
  str_count("Arkansas") 
state_frequencies <- state_frequencies %>%
  add_row(state="arkansas",frequency=2)
```

```{r}
usa_data %>%
  str_count("California") 
state_frequencies <- state_frequencies %>%
  add_row(state="california",frequency=19)
```

```{r}
usa_data %>%
  str_count("Colorado") 
state_frequencies <- state_frequencies %>%
  add_row(state="colorado",frequency=1)
```

```{r}
usa_data %>%
  str_count("Florida") 
state_frequencies <- state_frequencies %>%
  add_row(state="florida",frequency=2)
```

```{r}
usa_data %>%
  str_count("Georgia") 
state_frequencies <- state_frequencies %>%
  add_row(state="georgia",frequency=1) 
```

```{r}
usa_data %>%
  str_count("Illinois") 
state_frequencies <- state_frequencies %>%
  add_row(state="illinois",frequency=5)
```

```{r}
usa_data %>%
  str_count("Indiana") 
state_frequencies <- state_frequencies %>%
  add_row(state="indiana",frequency=2)
```

```{r}
usa_data %>%
  str_count("Kentucky") 
state_frequencies <- state_frequencies %>%
  add_row(state="kentucky",frequency=1)
```

```{r}
usa_data %>%
  str_count("Maine") 
state_frequencies <- state_frequencies %>%
  add_row(state="maine",frequency=1)
```

```{r}
usa_data %>%
  str_count("Massachusetts") 
state_frequencies <- state_frequencies %>%
  add_row(state="massachusetts",frequency=3) 
```

```{r}
usa_data %>%
  str_count("Michigan") 
state_frequencies <- state_frequencies %>%
  add_row(state="michigan",frequency=4)
```

```{r}
usa_data %>%
  str_count("Nebraska") 
state_frequencies <- state_frequencies %>%
  add_row(state="nebraska",frequency=1)
```


```{r}
usa_data %>%
  str_count("New Jersey") 
state_frequencies <- state_frequencies %>%
  add_row(state="new jersey",frequency=2)
```

```{r}
usa_data %>%
  str_count("New York") 
state_frequencies <- state_frequencies %>%
  add_row(state="new york",frequency=4)
```

```{r}
usa_data %>%
  str_count("North Carolina") 
state_frequencies <- state_frequencies %>%
  add_row(state="north carolina",frequency=1)
```

```{r}
usa_data %>%
  str_count("Ohio") 
state_frequencies <- state_frequencies %>%
  add_row(state="ohio",frequency=2)
```

```{r}
usa_data %>%
  str_count("Oklahoma") 
state_frequencies <- state_frequencies %>%
  add_row(state="oklahoma",frequency=1)
```

```{r}
usa_data %>%
  str_count("Pennsylvania") 
state_frequencies <- state_frequencies %>%
  add_row(state="pennsylvania",frequency=5)
```

```{r}
usa_data %>%
  str_count("Rhode Island") 
state_frequencies <- state_frequencies %>%
  add_row(state="rhode island",frequency=1)
```

```{r}
usa_data %>%
  str_count("South Dakota") 
state_frequencies <- state_frequencies %>%
  add_row(state="south dakota",frequency=2)
```

```{r}
usa_data %>%
  str_count("Tennessee") 
state_frequencies <- state_frequencies %>%
  add_row(state="tennessee",frequency=1)
```

```{r}
usa_data %>%
  str_count("Texas") 
state_frequencies <- state_frequencies %>%
  add_row(state="texas",frequency=2)
```

```{r}
usa_data %>%
  str_count("Utah") 
state_frequencies <- state_frequencies %>%
  add_row(state="utah",frequency=3)
```

```{r}
usa_data %>%
  str_count("Vermont") 
state_frequencies <- state_frequencies %>%
  add_row(state="vermont",frequency=1)
```

```{r}
usa_data %>%
  str_count("Virginia") 
state_frequencies <- state_frequencies %>%
  add_row(state="virginia",frequency=3)
```

```{r}
usa_data %>%
  str_count("Wisconsin") 
state_frequencies <- state_frequencies %>%
  add_row(state="wisconsin",frequency=2)
```
  
```{r}
state_frequencies
```

```{r}
 state_frequencies %>%
  summarise(sum=sum(frequency))
```

```{r}
state_data <- left_join(usa_shapefile,state_frequencies,by="state")
```



```{r}
usa_frequencies <- state_data %>%
  ggplot(aes(x=long,y=lat,fill=frequency,group=group)) + 
  geom_polygon(color="black",linewidth=0.125,alpha=0.75) +
  scale_fill_gradient(low="lavender",high="slateblue4",na.value="white",name="Intervention-Receiving Institutions",guide=guide_colourbar(reverse=FALSE,alpha=0.75,title.position="top",title.hjust=0.5,limits=c(1,74))) +
  xlab("") + 
  ylab("") +
  labs(caption="") +
  coord_map() +
  theme(legend.key.width=unit(3,"lines"),legend.position="none",legend.justification="center",legend.box.spacing=unit(-15,"pt"),legend.key.size=unit(10,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="aliceblue"),panel.border=element_rect(fill=NA),axis.text=element_blank(),axis.ticks=element_blank(),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
usa_frequencies
```



```{r}
uk_data <- read.csv("/Users/kenjinchang/github/scr-and-stakeholder-analysis/data/parent-files/review-data.csv") %>%
  select(country..if.in.UK.) %>%
  rename(region=country..if.in.UK.) 
```

```{r}
uk_data %>%
  str_count("England") 
country_frequencies <- tibble(country="Great Britain",
       frequency=13)
```

```{r}
uk_data %>%
  str_count("Scotland") 
country_frequencies <- country_frequencies %>%
  add_row(country="Scotland",frequency=1)
```

```{r}
uk_data %>%
  str_count("Wales") 
country_frequencies <- country_frequencies %>%
  add_row(country="Wales",frequency=1)
```

```{r}
uk_shapefile %>%
  distinct(subregion)
```
```{r}
uk_shapefile <- uk_shapefile %>%
  rename(country=subregion)
```

great britain vs england

```{r}
country_data <- left_join(uk_shapefile,country_frequencies,by="country")
```
  
  
```{r}
uk_frequencies <- country_data %>%
  ggplot(aes(x=long,y=lat,fill=frequency,group=group)) + 
  geom_polygon(color="black",linewidth=0.125,alpha=0.75) +
  scale_fill_gradient(low="lavender",high="slateblue4",na.value="white",name="Intervention-Receiving Institutions",guide=guide_colourbar(reverse=FALSE,alpha=0.75,title.position="top",title.hjust=0.5,limits=c(1,74))) +
  xlab("") + 
  ylab("") +
  labs(caption="") +
  coord_map() + 
  theme(legend.key.width=unit(3,"lines"),legend.position="none",legend.justification="center",legend.box.spacing=unit(-15,"pt"),legend.key.size=unit(10,"pt"),panel.grid=element_blank(),panel.background=element_rect(fill="aliceblue"),panel.border=element_rect(fill=NA),axis.text=element_blank(),axis.ticks=element_blank(),legend.title=element_text(size=10),legend.text=element_text(size=10),plot.title=element_text(size=10))
uk_frequencies
```


```{r}
subregion_frequencies <- ggarrange(usa_frequencies,uk_frequencies,
          ncol=2,
          widths=c(2,1),
          labels=c("B","C"))
subregion_frequencies
```
```{r}
region_frequencies <- ggarrange(global_frequencies,
          labels="A",
          legend="none")
region_frequencies
```






